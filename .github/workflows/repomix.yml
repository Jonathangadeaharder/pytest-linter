name: Repomix Codebase

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  repomix:
    name: Generate Repomixed Codebase
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for better context

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install repomix
      run: npm install -g repomix

    - name: Generate repomixed codebase
      run: |
        # Run repomix to generate the combined codebase
        repomix --output repomix-output.txt

        # Display some stats about the generated file
        echo "ðŸ“Š Repomix Statistics:"
        echo "File size: $(du -h repomix-output.txt | cut -f1)"
        echo "Line count: $(wc -l < repomix-output.txt)"

        # Create a metadata file with run information
        cat > repomix-metadata.json << EOF
        {
          "generated_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "repository": "${{ github.repository }}",
          "branch": "${{ github.ref_name }}",
          "commit": "${{ github.sha }}",
          "workflow_run": "${{ github.run_id }}",
          "file_size_bytes": $(stat -f%z repomix-output.txt 2>/dev/null || stat -c%s repomix-output.txt),
          "line_count": $(wc -l < repomix-output.txt)
        }
        EOF

    - name: Upload repomix output as artifact
      uses: actions/upload-artifact@v4
      with:
        name: repomix-codebase-${{ github.sha }}
        path: |
          repomix-output.txt
          repomix-metadata.json
        retention-days: 30
        compression-level: 9

    - name: Create summary
      run: |
        echo "## ðŸ“¦ Repomix Codebase Generated" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
        echo "- **File Size:** $(du -h repomix-output.txt | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "- **Line Count:** $(wc -l < repomix-output.txt | tr -d ' ')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ Download" >> $GITHUB_STEP_SUMMARY
        echo "The repomixed codebase has been uploaded as an artifact and will be available for 30 days." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "You can download it from the [workflow run artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})." >> $GITHUB_STEP_SUMMARY

    - name: Comment on PR (if applicable)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const metadata = JSON.parse(fs.readFileSync('repomix-metadata.json', 'utf8'));

          const comment = `## ðŸ“¦ Repomix Codebase Generated

          A combined view of the codebase has been generated using repomix.

          ### ðŸ“Š Statistics
          - **File Size:** ${(metadata.file_size_bytes / 1024).toFixed(2)} KB
          - **Line Count:** ${metadata.line_count.toLocaleString()}
          - **Commit:** \`${metadata.commit.substring(0, 7)}\`

          ### ðŸ“¥ Download
          Download the artifact from the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).

          The artifact will be available for 30 days.`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

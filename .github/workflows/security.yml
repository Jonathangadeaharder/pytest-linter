name: Security Scanning

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  pull-requests: write
  actions: read  # Required for dependency-review-action

jobs:
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    # Only run on pull requests
    if: github.event_name == 'pull_request'

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for dependency comparison

    - name: Dependency Review
      uses: actions/dependency-review-action@v4
      with:
        # Allow development to continue with warnings, only fail on critical
        fail-on-severity: critical
        # Allow common open source licenses
        allow-licenses: MIT, Apache-2.0, BSD-3-Clause, BSD-2-Clause, ISC, Python-2.0, PSF-2.0, GPL-3.0
        # Explicitly specify comparison refs
        base-ref: ${{ github.base_ref }}
        head-ref: ${{ github.head_ref }}

  safety-check:
    name: Safety Check (Python Dependencies)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install safety

    - name: Run Safety check
      continue-on-error: true
      run: |
        # Check installed dependencies for known vulnerabilities
        pip install -e ".[dev]"
        safety check --json

    - name: Run pip-audit
      continue-on-error: true
      run: |
        pip install pip-audit
        pip-audit --desc

  bandit:
    name: Bandit Security Linter
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install Bandit
      run: pip install bandit[toml]

    - name: Run Bandit
      continue-on-error: true
      run: |
        bandit -r pytest_deep_analysis/ -f json -o bandit-report.json
        bandit -r pytest_deep_analysis/

    - name: Upload Bandit report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bandit-security-report
        path: bandit-report.json
        retention-days: 30
        if-no-files-found: warn

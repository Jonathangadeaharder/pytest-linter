name: Security Scanning

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  pull-requests: write
  actions: read  # Required for dependency-review-action

jobs:
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    # Only run on pull requests
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true

    - name: Dependency Review
      id: dependency-review
      continue-on-error: true
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: critical
        allow-licenses: MIT, Apache-2.0, BSD-3-Clause, BSD-2-Clause, ISC, Python-2.0, PSF-2.0

    - name: Log Dependency Review results
      if: always()
      run: |
        echo "Dependency Review completed with outcome: ${{ steps.dependency-review.outcome }}" | tee dependency-review.log
        echo "Job status: ${{ job.status }}" | tee -a dependency-review.log

        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Check out the actual branch (not the merge commit)
        BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
        echo "Checking out branch: $BRANCH_NAME" | tee -a dependency-review.log
        git fetch origin "$BRANCH_NAME"
        git checkout "$BRANCH_NAME"

        # Add log file
        git add -f dependency-review.log

        if [ "${{ steps.dependency-review.outcome }}" != "success" ]; then
          echo "FAILED: Dependency Review found issues" | tee -a dependency-review.log
          git commit -m "Add Dependency Review failure log [skip ci]"
          git push origin "$BRANCH_NAME"
          exit 1
        else
          echo "SUCCESS: Dependency Review passed" | tee -a dependency-review.log
          git commit -m "Add Dependency Review success log [skip ci]"
          git push origin "$BRANCH_NAME"
        fi

  safety-check:
    name: Safety Check (Python Dependencies)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install safety

    - name: Run Safety check
      continue-on-error: true
      run: |
        # Check installed dependencies for known vulnerabilities
        pip install -e ".[dev]"
        safety check --json

    - name: Run pip-audit
      continue-on-error: true
      run: |
        pip install pip-audit
        pip-audit --desc

  bandit:
    name: Bandit Security Linter
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install Bandit
      run: pip install bandit[toml]

    - name: Run Bandit
      continue-on-error: true
      run: |
        bandit -r pytest_deep_analysis/ -f json -o bandit-report.json
        bandit -r pytest_deep_analysis/

    - name: Upload Bandit report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bandit-security-report
        path: bandit-report.json
        retention-days: 30
        if-no-files-found: warn
